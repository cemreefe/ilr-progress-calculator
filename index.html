<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Earned Settlement Calculator</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/N6f9RSWN/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    },
                    colors: {
                        stone: {
                            50: '#fafaf9',
                            100: '#f5f5f4',
                            200: '#e7e5e4',
                            300: '#d6d3d1',
                            400: '#a8a29e',
                            500: '#78716c',
                            600: '#57534e',
                            700: '#44403c',
                            800: '#292524',
                            900: '#1c1917',
                        },
                        teal: {
                            850: '#134e4a', // Custom deep teal
                            950: '#042f2e',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #fafaf9; /* Stone 50 */
            color: #292524; /* Stone 800 */
            -webkit-font-smoothing: antialiased;
        }
        
        /* Custom Form Controls */
        .form-input, .form-select {
            appearance: none;
            background-color: #ffffff;
            border-color: #d6d3d1; /* Stone 300 - Increased contrast from 200 */
            border-width: 1px;
            border-radius: 0.5rem;
            padding-top: 0.75rem;
            padding-right: 1rem;
            padding-bottom: 0.75rem;
            padding-left: 1rem;
            font-size: 0.95rem;
            line-height: 1.5rem;
            color: #1c1917; /* Stone 900 */
            --tw-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --tw-shadow-colored: 0 1px 2px 0 var(--tw-shadow-color);
            box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
            transition: all 0.2s ease-in-out;
        }
        
        .form-input:focus, .form-select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-offset-width: 0px;
            --tw-ring-width: 1px;
            /* Changed to Teal for accent */
            --tw-ring-color: #0f766e; /* Teal 700 */
            border-color: #0f766e;
            box-shadow: 0 0 0 1px #0f766e;
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2344403c' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); /* Darker chevron */
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .form-select:disabled, .form-input:disabled, .disabled-control {
            background-color: #f5f5f4; /* Stone 100 */
            color: #a8a29e; /* Stone 400 */
            cursor: not-allowed;
            border-color: #e7e5e4;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a8a29e' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        }

        /* Card Styling */
        .chic-card {
            background-color: white;
            border: 1px solid #e7e5e4;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.02), 0 2px 4px -2px rgb(0 0 0 / 0.02); /* Slightly deeper shadow */
        }

        /* Typography Overrides */
        h1, h2, h3 {
            font-family: 'Playfair Display', serif;
        }

        /* Tooltips */
        .chic-tooltip {
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s ease;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(4px);
            z-index: 50;
            background-color: #042f2e; /* Teal 950 */
            color: #f0fdfa; /* Teal 50 */
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            font-family: 'Inter', sans-serif;
            font-weight: 400;
            font-size: 0.75rem;
            width: max-content;
            max-width: 280px;
            text-align: left;
            pointer-events: none;
            margin-bottom: 0.5rem;
            border: 1px solid #134e4a;
        }
        
        .group:hover .chic-tooltip {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        
        /* References tooltip with delayed hide */
        .refs-tooltip {
            transition: opacity 0.2s ease, visibility 0.2s ease;
            transition-delay: 0.2s; /* Delay before hiding */
        }
        .group:hover .refs-tooltip {
            transition-delay: 0s; /* No delay when showing */
        }
        
        hr {
            border-color: #e7e5e4;
        }
        
        /* Animations */
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Hide browser default UI */
        #calculate-button, #reset-button { display: none; }
        
        /* Range input accent */
        input[type="radio"]:checked + div {
            border-color: #0f766e; /* Teal 700 */
        }
        input[type="radio"]:checked + div + span {
            color: #0f766e;
            font-weight: 500;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4 sm:px-6 lg:px-8 selection:bg-teal-100 selection:text-teal-900 bg-gradient-to-b from-stone-50 to-stone-100">

    <div class="max-w-3xl mx-auto space-y-8">
        
        <!-- Header -->
        <header class="text-center space-y-4 fade-in">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white shadow-sm border border-stone-100 mb-2 relative overflow-hidden p-3">
                <div class="absolute inset-0 bg-gradient-to-br from-teal-50 to-stone-50 opacity-50"></div>
                <img src="https://openclipart.org/image/800px/222627" alt="Union Jack Heart" class="relative z-10 w-full h-full object-contain opacity-90">
            </div>
            <h1 class="text-4xl sm:text-5xl font-medium text-stone-900 tracking-tight">Earned Settlement Calculator</h1>
            <p class="text-stone-600 max-w-xl mx-auto font-light text-lg leading-relaxed">
                Estimate your earliest Indefinite Leave to Remain (ILR) application date under the proposed <a href="https://www.gov.uk/government/consultations/earned-settlement" target="_blank" class="underline hover:text-teal-700 font-medium">Earned Settlement</a> changes.
            </p>
            
            <div class="flex flex-col items-center gap-3 mt-2">
                <a href="https://buymeacoffee.com/cemreefe" target="_blank" class="inline-flex items-center gap-2 px-4 py-1.5 bg-[#FFDD00] hover:bg-[#FFDD00]/90 text-stone-900 text-xs font-semibold rounded-full transition-all shadow-sm hover:shadow-md border border-yellow-400/50 -rotate-1 hover:rotate-0 transform duration-200">
                    <span>‚òïÔ∏è</span> Buy me a coffee
                </a>
                <p class="text-[10px] text-stone-400">
                    unofficial tool by <a href="https://cemrekarakas.com" target="_blank" class="hover:text-teal-700 font-medium underline decoration-stone-300 underline-offset-2 transition-colors">cemre</a>
                </p>
            </div>
        </header>

        <!-- Dependent Warning -->
        <div id="dependent-warning-banner" class="hidden rounded-xl border border-amber-200 bg-amber-50 p-5 text-sm text-amber-900 flex items-start gap-4 fade-in shadow-sm">
            <span class="text-xl bg-amber-100 w-8 h-8 flex items-center justify-center rounded-full">‚ö†Ô∏è</span>
            <div>
                <p class="font-semibold font-serif text-lg text-amber-900 mb-1">Guidance Pending: Dependent Visa Holders</p>
                <p class="text-amber-800/90 leading-relaxed">The settlement rules for Dependent visa holders haven't been published yet. Calculations are disabled until further guidance.</p>
            </div>
        </div>

        <div class="grid lg:grid-cols-1 gap-8">
            <!-- Main Calculator Form -->
            <div id="calculator-form" class="chic-card p-6 sm:p-10 space-y-9 relative overflow-visible">
                <!-- Step 1 -->
                <section class="space-y-6 relative">
                    <!-- Connecting line -->
                    <div class="absolute left-[11px] top-8 bottom-0 w-0.5 bg-stone-100 -z-10 h-full opacity-50"></div>
                    
                    <div class="flex items-center gap-4">
                        <span class="flex h-6 w-6 items-center justify-center rounded-full bg-teal-850 text-xs font-semibold text-teal-50 shadow-sm ring-2 ring-white">1</span>
                        <h2 class="text-xl font-medium text-stone-900">Residence & Baseline</h2>
                    </div>
                    
                    <div class="grid sm:grid-cols-2 gap-6 pl-10">
                        <div class="space-y-2">
                            <label for="entry-date" class="flex items-center text-sm font-semibold text-stone-700">
                                Lawful Residence Start Date
                                <div class="relative group ml-2 cursor-help">
                                    <span class="text-stone-400 hover:text-teal-600 transition-colors bg-stone-100 rounded-full w-4 h-4 flex items-center justify-center text-xs font-bold">?</span>
                                    <div class="chic-tooltip w-80">
                                        <strong class="block mb-2 text-teal-200 font-semibold">What counts as the start date?</strong>
                                        <p class="text-stone-300 mb-2">This is typically the <strong>start date on your entry clearance vignette</strong> (the sticker in your passport), not the date you physically entered the UK.</p>
                                        <div class="mt-2 pt-2 border-t border-teal-900 text-stone-400">
                                            For visa extensions or switches, use the date your continuous lawful residence began on a qualifying route.
                                        </div>
                                    </div>
                                </div>
                            </label>
                            <input type="date" id="entry-date" class="form-input w-full" value="2026-04-01">
                        </div>

                        <div class="space-y-2">
                            <label for="visa-category" class="block text-sm font-semibold text-stone-700">Primary Visa Route</label>
                            <select id="visa-category" class="form-select w-full">
                                <option value="10">Standard Baseline (Skilled Worker, Student, etc.)</option>
                                <option value="5_FAMILY">Family/Partner (5 Years Fixed)</option>
                                <option value="5_BNO">BN(O) Route (5 Years Fixed)</option>
                                <option value="3_FASTTRACK">Global Talent / Innovator (3 Years Fixed)</option>
                                <option value="5_GLOBALPROMISE">Global Promise (5 Years Adjustable)</option>
                                <option value="5_PUBLIC">Public Service Roles (5 Years Fixed)</option>
                                <option value="15">Medium/Lower Skilled (15 Years)</option>
                                <option value="20">Refugee (20 Years)</option>
                                <option value="0_DEPENDENT">Visa Holder's Dependent</option>
                            </select>
                            <p class="text-xs text-stone-500 text-right">Base requirement: <span id="base-years" class="font-bold text-teal-800">10</span> years</p>
                        </div>
                    </div>
                </section>

                <hr class="border-stone-100 ml-10">

                <!-- Step 2 -->
                <section class="space-y-6 relative">
                     <!-- Connecting line -->
                     <div class="absolute left-[11px] top-8 bottom-0 w-0.5 bg-stone-100 -z-10 h-full opacity-50"></div>

                    <div class="flex items-center justify-between">
                         <div class="flex items-center gap-4">
                            <span class="flex h-6 w-6 items-center justify-center rounded-full bg-teal-850 text-xs font-semibold text-teal-50 shadow-sm ring-2 ring-white">2</span>
                            <h2 class="text-xl font-medium text-stone-900">Positive Adjustments</h2>
                        </div>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-teal-800 bg-teal-50 border border-teal-100 px-2 py-1 rounded-md">Reductions</span>
                    </div>

                    <div class="pl-10 space-y-6">
                        <!-- Note -->
                        <p id="reduction-note" class="text-sm bg-stone-50 text-stone-600 p-3 rounded-md border border-stone-200 hidden">
                            This route has a fixed timeline and is not subject to earned reductions.
                        </p>
                        <p id="reduction-note-default" class="text-sm text-stone-500 leading-relaxed">
                            Earn reductions to your baseline wait time. <br>
                            <span class="text-stone-400 italic text-xs">Only the single largest applicable reduction is applied.</span>
                        </p>

                        <div id="reduction-controls" class="space-y-6">
                            <!-- High Earner -->
                            <div class="space-y-2">
                                <label for="high-earner" class="flex items-center text-sm font-semibold text-stone-700">
                                    Annual Taxable Income
                                    <div class="relative group ml-2 cursor-help">
                                        <span class="text-stone-400 hover:text-teal-600 transition-colors bg-stone-100 rounded-full w-4 h-4 flex items-center justify-center text-xs font-bold">?</span>
                                        <div class="chic-tooltip w-72">
                                            <strong class="block mb-2 text-teal-200 font-semibold">Income Reductions</strong>
                                            <ul class="space-y-1 list-disc pl-4 text-stone-300">
                                                <li>High Earner (¬£50,270+): -5 years</li>
                                                <li>Max Earner (¬£125,140+): -7 years</li>
                                            </ul>
                                            <div class="mt-2 pt-2 border-t border-teal-900 text-stone-400">
                                                Must be met for 3 consecutive years immediately prior to application.
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                <select id="high-earner" class="form-select w-full">
                                    <option value="0">Standard Earnings (‚â• ¬£12,500)</option>
                                    <option value="-5">High Earner (‚â• ¬£50,270 for 3 years)</option>
                                    <option value="-7">Max Earner (‚â• ¬£125,140 for 3 years)</option>
                                    <option value="99">Income Barred (< ¬£12,500)</option>
                                </select>
                                
                                <!-- Dynamic Income Controls -->
                                <div id="earning-date-controls" class="mt-4 p-5 bg-stone-50/80 rounded-lg border border-stone-200 hidden animate-fade-in">
                                    <div class="flex items-center mb-3">
                                        <label class="text-sm font-bold text-stone-700">Income History</label>
                                        <div class="relative group ml-2 cursor-help">
                                            <span class="text-stone-400 hover:text-teal-600 transition-colors bg-stone-100 rounded-full w-4 h-4 flex items-center justify-center text-xs font-bold">?</span>
                                            <div class="chic-tooltip w-80">
                                                <strong class="block mb-2 text-teal-200 font-semibold">3-Year Requirement</strong>
                                                <p class="text-stone-300 mb-2">Your annual taxable income must meet the threshold for <strong>3 consecutive years</strong> immediately before your application.</p>
                                                <div class="mt-2 pt-2 border-t border-teal-900 text-stone-400">
                                                    <strong class="text-teal-200">Pro-rated calculation:</strong><br>
                                                    If your income changed mid-year, we calculate your total earnings for that tax year. E.g., ¬£100k for 6 months + ¬£150k for 6 months = ¬£125k annual income.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-3 mb-4">
                                        <label class="flex items-center cursor-pointer group">
                                            <div class="relative flex items-center">
                                                <input type="radio" id="salary-start-same" name="salary-start-time" value="same" checked class="peer sr-only">
                                                <div class="w-4 h-4 border-2 border-stone-300 rounded-full peer-checked:border-teal-700 peer-checked:bg-teal-700 transition-all"></div>
                                            </div>
                                            <span class="ml-3 text-sm text-stone-600 group-hover:text-stone-900 transition-colors">My taxable income has been above this threshold since <span id="income-threshold-date" class="font-semibold text-stone-700"></span></span>
                                        </label>
                                        <label class="flex items-center cursor-pointer group">
                                            <div class="relative flex items-center">
                                                <input type="radio" id="salary-start-other" name="salary-start-time" value="other" class="peer sr-only">
                                                <div class="w-4 h-4 border-2 border-stone-300 rounded-full peer-checked:border-teal-700 peer-checked:bg-teal-700 transition-all"></div>
                                            </div>
                                            <span class="ml-3 text-sm text-stone-600 group-hover:text-stone-900 transition-colors">My taxable income was below this threshold for a while</span>
                                        </label>
                                    </div>
                                    
                                    <!-- Income History Inputs -->
                                    <div id="salary-history-section" class="hidden space-y-4 pt-3 border-t border-stone-200">
                                        <p class="text-xs text-stone-500">Log your taxable income changes starting from <strong id="salary-start-label" class="text-stone-700">arrival</strong>.</p>
                                        
                                        <div id="salary-history-container" class="space-y-3">
                                            <div class="salary-entry grid grid-cols-2 gap-3" data-index="0">
                                                <div>
                                                    <label class="text-[10px] uppercase tracking-wider font-bold text-stone-400 mb-1 block">Effective Date</label>
                                                    <input type="date" id="first-salary-date" class="salary-start-date w-full text-sm px-3 py-2 bg-stone-100 border border-stone-200 rounded text-stone-500 cursor-not-allowed" readonly>
                                                </div>
                                                <div>
                                                    <label class="text-[10px] uppercase tracking-wider font-bold text-stone-400 mb-1 block">Annual Taxable Income (¬£)</label>
                                                    <input type="number" class="salary-amount w-full text-sm px-3 py-2 bg-white border border-stone-200 rounded focus:ring-1 focus:ring-teal-700 focus:border-teal-700 transition-shadow font-medium" placeholder="45000" min="0">
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <button type="button" id="add-salary-btn" class="text-sm text-teal-700 hover:text-teal-900 font-semibold flex items-center gap-1 transition-colors mt-2">
                                            <span class="text-lg leading-none">+</span> Add another period
                                        </button>
                                        
                                        <!-- Calculation Feedback -->
                                        <div id="salary-calculation-box" class="mt-4 p-3 bg-amber-50/50 border border-amber-100 rounded text-sm text-amber-900 hidden">
                                            <div id="salary-calculation-explanation" class="space-y-2 text-xs"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Error: Income Bar -->
                                <div id="income-bar-error" class="hidden p-3 rounded bg-rose-50 border border-rose-100 text-rose-700 text-sm flex gap-2 items-start">
                                    <span class="mt-0.5">üö´</span>
                                    <span><strong>Suitability Failed:</strong> Income must be ‚â• ¬£12,500/yr.</span>
                                </div>
                            </div>

                            <div class="grid sm:grid-cols-2 gap-6">
                                <!-- English -->
                                <div class="space-y-2">
                                    <label for="english-c1" class="block text-sm font-semibold text-stone-700">English Proficiency</label>
                                    <select id="english-c1" class="form-select w-full">
                                        <option value="0">B2 Level (Minimum)</option>
                                        <option value="-1">C1 Level (-1 year)</option>
                                        <option value="99">Below B2 (Barred)</option>
                                    </select>
                                    <div id="english-bar-error" class="hidden text-xs text-rose-600 mt-1">
                                        Requirement not met.
                                    </div>
                                </div>

                                <!-- Volunteering -->
                                <div class="space-y-2">
                                    <label for="volunteering" class="block text-sm font-semibold text-stone-700">Volunteering</label>
                                    <select id="volunteering" class="form-select w-full">
                                        <option value="0">None</option>
                                        <option value="-3">Sustained (3+ years, -3 years)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <p id="max-reduction-note" class="text-xs text-emerald-800 bg-emerald-50 p-3 rounded hidden border border-emerald-100 flex items-center gap-2">
                                <span class="text-emerald-600 text-lg">‚úì</span>
                                Max reduction (-7 years) achieved via income. Other factors suppressed.
                            </p>
                        </div>
                    </div>
                </section>

                <hr class="border-stone-100 ml-10">

                <!-- Step 3 -->
                <section class="space-y-6">
                    <div class="flex items-center justify-between">
                         <div class="flex items-center gap-4">
                            <span class="flex h-6 w-6 items-center justify-center rounded-full bg-teal-850 text-xs font-semibold text-teal-50 shadow-sm ring-2 ring-white">3</span>
                            <h2 class="text-xl font-medium text-stone-900">Negative Adjustments</h2>
                        </div>
                        <span class="text-[10px] font-bold uppercase tracking-widest text-stone-500 bg-stone-100 border border-stone-200 px-2 py-1 rounded-md">Penalties</span>
                    </div>

                    <div class="pl-10 grid sm:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="public-funds" class="block text-sm font-semibold text-stone-700">Public Funds</label>
                            <select id="public-funds" class="form-select w-full">
                                <option value="0">None</option>
                                <option value="5">Received < 12 months (+5 years)</option>
                                <option value="10">Received ‚â• 12 months (+10 years)</option>
                            </select>
                        </div>

                        <div class="space-y-2">
                            <label for="immigration-breach" class="block text-sm font-semibold text-stone-700">Immigration History</label>
                            <select id="immigration-breach" class="form-select w-full">
                                <option value="0">Clean history</option>
                                <option value="20">Serious Breach (+20 years)</option>
                            </select>
                        </div>
                    </div>
                </section>
                
                <!-- Hidden Buttons kept for logic structure if needed, but hidden via CSS -->
                <button id="calculate-button">Calculate</button>
                <button id="reset-button">Reset</button>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="space-y-6 fade-in">
                
                <!-- Main Result Card -->
                <div id="result-message" class="bg-stone-900 text-stone-50 rounded-2xl p-8 shadow-2xl relative overflow-hidden border border-stone-800">
                    <!-- Decorative background element -->
                    <div class="absolute top-0 right-0 -mt-12 -mr-12 w-48 h-48 bg-teal-900 rounded-full opacity-30 blur-3xl"></div>
                    <div class="absolute bottom-0 left-0 -mb-12 -ml-12 w-40 h-40 bg-stone-800 rounded-full opacity-50 blur-3xl"></div>
                    
                    <div class="relative z-10 text-center space-y-2">
                        <p class="text-stone-400 text-[11px] uppercase tracking-widest font-bold">Earliest ILR Application Date</p>
                        <p id="earliest-date" class="text-3xl sm:text-6xl font-serif text-transparent bg-clip-text bg-gradient-to-r from-teal-100 via-white to-stone-200 py-3 font-medium drop-shadow-sm">[Calculating...]</p>
                        
                        <div class="flex items-center justify-center gap-2 text-xs text-stone-400 mt-4">
                            <span>Includes 28-day early application allowance</span>
                            <div class="group relative cursor-help">
                                <span class="border border-stone-600 rounded-full w-4 h-4 flex items-center justify-center text-[10px] hover:border-stone-400 hover:text-stone-300 transition-colors">?</span>
                                <div class="chic-tooltip">You can apply up to 28 days before your qualifying period is complete.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Grid -->
                    <div class="grid grid-cols-2 gap-8 mt-10 pt-8 border-t border-stone-800/50">
                        <div class="text-center">
                            <p class="text-stone-500 text-[10px] uppercase tracking-widest mb-1 font-semibold">Total Required</p>
                            <p class="text-2xl font-light text-stone-200"><span id="final-required-years">0</span> <span class="text-sm text-stone-500">years</span></p>
                        </div>
                        <div class="text-center">
                            <p class="text-stone-500 text-[10px] uppercase tracking-widest mb-1 font-semibold">Baseline</p>
                            <p class="text-2xl font-light text-stone-200"><span id="display-baseline">0</span> <span class="text-sm text-stone-500">years</span></p>
                        </div>
                    </div>
                </div>
                
                <!-- References Section -->
                <div class="relative text-center py-2">
                    <span class="group inline-block">
                        <button class="text-[10px] text-stone-400 hover:text-teal-600 transition-colors cursor-pointer pb-2">
                            üìÑ View source references from Command Paper CP 1448
                        </button>
                        <div class="refs-tooltip invisible opacity-0 group-hover:visible group-hover:opacity-100 absolute top-full left-0 right-0 -mt-2 pt-2 z-50">
                            <div class="bg-stone-900 text-stone-200 rounded-xl p-5 shadow-2xl border border-stone-700 text-xs max-h-80 overflow-y-auto text-left">
                        <h4 class="font-bold text-teal-300 mb-3 text-sm">Source: "A Fairer Pathway to Settlement" (CP 1448, Nov 2025)</h4>
                        <ul class="space-y-2.5 text-stone-300">
                            <li class="flex gap-2">
                                <span class="text-teal-400 font-mono text-[10px] shrink-0">p.20-21</span>
                                <span><strong class="text-stone-100">10-year baseline:</strong> "The baseline qualifying period for settlement for most migrants is increased from 5 years to 10 years."</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="text-teal-400 font-mono text-[10px] shrink-0">p.21-22</span>
                                <span><strong class="text-stone-100">Table 2 - Reductions:</strong> High Earner (¬£50,270+ for 3 years): -5 years; Max Earner (¬£125,140+ for 3 years): -7 years; C1 English: -1 year; Volunteering: -3 to -5 years</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="text-teal-400 font-mono text-[10px] shrink-0">p.22</span>
                                <span><strong class="text-stone-100">Table 3 - Penalties:</strong> Public funds &lt;12 months: +5 years; Public funds ‚â•12 months: +10 years; Serious breach: +20 years</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="text-teal-400 font-mono text-[10px] shrink-0">p.21</span>
                                <span><strong class="text-stone-100">Single adjustment rule:</strong> "Only one of the listed considerations (i.e. the one that causes the largest reduction/increase) would be applied."</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="text-teal-400 font-mono text-[10px] shrink-0">p.21</span>
                                <span><strong class="text-stone-100">English requirement:</strong> "The applicant must be able to evidence that they meet English language requirements, which will be at B2 level."</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="text-teal-400 font-mono text-[10px] shrink-0">p.20</span>
                                <span><strong class="text-stone-100">Fixed routes:</strong> Family (5 years), BN(O) (5 years), Global Talent/Innovator (3 years) retain fixed timelines.</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="text-teal-400 font-mono text-[10px] shrink-0">p.20</span>
                                <span><strong class="text-stone-100">Refugees:</strong> 20-year baseline for core protection route.</span>
                            </li>
                            <li class="flex gap-2">
                                <span class="text-teal-400 font-mono text-[10px] shrink-0">p.20</span>
                                <span><strong class="text-stone-100">Sub-RQF6 workers:</strong> 15-year baseline for roles below bachelor's degree level.</span>
                            </li>
                        </ul>
                        <p class="mt-4 pt-3 border-t border-stone-700 text-stone-500 text-[10px]">
                            Full document: <a href="https://www.gov.uk/government/consultations/earned-settlement" target="_blank" class="text-teal-400 hover:text-teal-300 underline">gov.uk/government/consultations/earned-settlement</a>
                        </p>
                            </div>
                        </div>
                    </span>
                </div>

                <!-- Adjustments Breakdown -->
                <div id="adjustments-grid" class="grid sm:grid-cols-2 gap-4">
                    <!-- Adjustments Card -->
                    <div id="adjustments-container" class="bg-white border border-stone-200 rounded-xl p-6 shadow-sm relative overflow-hidden">
                         <div class="absolute top-0 left-0 w-1 h-full bg-stone-100"></div>
                         <h3 class="text-sm font-bold text-stone-900 mb-4 pb-2 border-b border-stone-100 flex items-center gap-2">
                            <span>Adjustments</span>
                         </h3>
                         <div class="space-y-4 text-sm">
                            <div class="flex justify-between items-center">
                                <span class="text-stone-500 font-medium">Reduction</span>
                                <div class="text-right">
                                    <span id="display-reduction-value" class="font-bold text-emerald-700">0 years</span>
                                    <p id="display-reduction-reason" class="text-[10px] text-stone-400 font-medium uppercase tracking-wide"></p>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-stone-500 font-medium">Penalty</span>
                                <div class="text-right">
                                    <span id="display-penalty-value" class="font-bold text-rose-700">0 years</span>
                                    <p id="display-penalty-reason" class="text-[10px] text-stone-400 font-medium uppercase tracking-wide"></p>
                                </div>
                            </div>
                             <div class="flex justify-between items-center pt-3 border-t border-stone-100">
                                <span class="text-stone-900 font-bold">Net Change</span>
                                <span id="display-adjustment" class="font-bold text-stone-900">0 years</span>
                            </div>
                         </div>
                         <p id="salary-check-indicator" class="text-xs text-amber-800 mt-4 bg-amber-50 p-2 rounded border border-amber-100 font-medium"></p>
                    </div>

                    <!-- Progress Card -->
                    <div id="progress-container" class="bg-white border border-stone-200 rounded-xl p-6 shadow-sm hidden relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-1 h-full bg-stone-100"></div>
                        <h3 class="text-sm font-bold text-stone-900 mb-4 pb-2 border-b border-stone-100">Timeline</h3>
                        <div class="space-y-5">
                             <div class="flex justify-between text-xs font-medium text-stone-500">
                                <span><strong id="days-completed" class="text-stone-900">0</strong> days done</span>
                                <span><strong id="days-remaining" class="text-stone-900">0</strong> left</span>
                            </div>
                            <div class="w-full bg-stone-100 rounded-full h-2.5 overflow-hidden shadow-inner">
                                <div id="progress-bar" class="bg-gradient-to-r from-teal-700 to-emerald-600 h-2.5 rounded-full transition-all duration-1000 ease-out shadow-sm" style="width: 0%"></div>
                            </div>
                             <div class="text-center">
                                 <p class="text-2xl font-serif text-stone-800"><span id="progress-percent">0%</span></p>
                                 <p class="text-[10px] uppercase tracking-widest text-stone-400 mt-0.5 font-medium">Complete</p>
                             </div>
                             <p class="text-[10px] text-stone-300 text-center pt-2 border-t border-stone-50">Total Duration: <span id="total-days">0</span> days</p>
                        </div>
                    </div>
                </div>
                
                <!-- Milestones -->
                <div id="milestone-dates" class="hidden">
                    <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest text-center mb-4">Key Milestones</p>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="text-center p-3 bg-white rounded-lg border border-stone-200 shadow-sm hover:border-teal-200 transition-colors">
                            <p class="text-[10px] font-bold text-stone-400 mb-1">25%</p>
                            <p id="date-25" class="text-sm font-semibold text-stone-700">...</p>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg border border-stone-200 shadow-sm hover:border-teal-200 transition-colors">
                            <p class="text-[10px] font-bold text-stone-400 mb-1">50%</p>
                            <p id="date-50" class="text-sm font-semibold text-stone-700">...</p>
                        </div>
                        <div class="text-center p-3 bg-white rounded-lg border border-stone-200 shadow-sm hover:border-teal-200 transition-colors">
                            <p class="text-[10px] font-bold text-stone-400 mb-1">75%</p>
                            <p id="date-75" class="text-sm font-semibold text-stone-700">...</p>
                        </div>
                    </div>
                </div>

                <!-- Barred Message -->
                <div id="barred-message" class="bg-rose-50 border border-rose-200 rounded-xl p-8 text-center hidden shadow-sm">
                    <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-rose-100 mb-3 text-2xl">‚õî</div>
                    <h3 class="text-xl font-serif text-rose-900 mb-2">Settlement Not Eligible</h3>
                    <p id="barred-reason" class="text-rose-800 text-sm font-medium max-w-md mx-auto"></p>
                </div>
                
                <!-- Share Button -->
                <div class="text-center pt-4">
                    <button id="share-btn" class="inline-flex items-center gap-2 px-5 py-2.5 bg-teal-700 hover:bg-teal-800 text-white text-sm font-semibold rounded-lg transition-all shadow-sm hover:shadow-md">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.18.324.283.696.283 1.093s-.103.77-.283 1.093m0-2.186 9.566-5.314m-9.566 7.5 9.566 5.314m0 0a2.25 2.25 0 1 0 3.935 2.186 2.25 2.25 0 0 0-3.935-2.186Zm0-12.814a2.25 2.25 0 1 0 3.933-2.185 2.25 2.25 0 0 0-3.933 2.185Z" />
                        </svg>
                        <span id="share-btn-text">Share this tracker</span>
                    </button>
                    <p id="share-feedback" class="text-xs text-teal-700 mt-2 hidden font-medium"></p>
                </div>
                
                <div class="text-center pt-4 pb-4 space-y-3">
                    <p class="text-[10px] text-stone-400 max-w-md mx-auto leading-relaxed">
                        Disclaimer: This tool is for illustrative purposes based on proposed policies. It does not constitute legal advice. 
                        Rules are subject to change.
                    </p>
                    <p class="text-[10px] text-stone-400">
                        Looking for the old 5-year ILR tracker? <a href="https://cemrekarakas.com/misc/web/ilr-progress" target="_blank" class="text-teal-600 hover:text-teal-700 underline underline-offset-2">Check it out here</a>
                    </p>
                    <p class="text-[10px] text-stone-400 mt-2">
                        Open source ¬∑ <a href="https://github.com/cemreefe/ilr-progress-calculator/" target="_blank" class="text-teal-600 hover:text-teal-700 underline underline-offset-2">View source on GitHub</a>
                    </p>
                </div>
                
            </div>
        </div>
    </div>

    <script>
        // --- Core Application Logic (ILR Earned Settlement) ---

        // Constants and Helpers
        const ONE_YEAR_DAYS = 365.25; 
        const DAYS_TO_SUBTRACT = 28; 
        const MS_IN_DAY = 24 * 60 * 60 * 1000;
        const THREE_YEARS_IN_DAYS = 3 * ONE_YEAR_DAYS;

        const elements = {
            visaCategory: document.getElementById('visa-category'),
            entryDate: document.getElementById('entry-date'),
            
            highEarnerControl: document.getElementById('high-earner'),
            englishC1Control: document.getElementById('english-c1'),
            volunteeringControl: document.getElementById('volunteering'),
            
            publicFunds: document.getElementById('public-funds'),
            immigrationBreach: document.getElementById('immigration-breach'),

            // Earnings Controls
            earningDateControls: document.getElementById('earning-date-controls'),
            salaryHistorySection: document.getElementById('salary-history-section'),
            salaryHistoryContainer: document.getElementById('salary-history-container'),
            addSalaryBtn: document.getElementById('add-salary-btn'),
            salaryStartSameRadio: document.getElementById('salary-start-same'),
            salaryStartOtherRadio: document.getElementById('salary-start-other'),
            firstSalaryDate: document.getElementById('first-salary-date'),
            salaryStartLabel: document.getElementById('salary-start-label'),
            salaryCheckIndicator: document.getElementById('salary-check-indicator'),
            salaryCalculationBox: document.getElementById('salary-calculation-box'),
            salaryCalculationExplanation: document.getElementById('salary-calculation-explanation'),
            
            // UI elements
            dependentWarningBanner: document.getElementById('dependent-warning-banner'),
            reductionNote: document.getElementById('reduction-note'),
            reductionNoteDefault: document.getElementById('reduction-note-default'),
            maxReductionNote: document.getElementById('max-reduction-note'), 

            // Error Messages
            incomeBarError: document.getElementById('income-bar-error'),
            englishBarError: document.getElementById('english-bar-error'),

            // Output elements
            baseYears: document.getElementById('base-years'),
            displayBaseline: document.getElementById('display-baseline'),
            displayReductionValue: document.getElementById('display-reduction-value'), 
            displayReductionReason: document.getElementById('display-reduction-reason'), 
            displayPenaltyValue: document.getElementById('display-penalty-value'), 
            displayPenaltyReason: document.getElementById('display-penalty-reason'), 
            displayAdjustment: document.getElementById('display-adjustment'),
            finalRequiredYears: document.getElementById('final-required-years'),
            // residenceCompletionDate: document.getElementById('residence-completion-date'), // Removed from UI but kept in logic if referenced
            earliestDate: document.getElementById('earliest-date'),
            barredMessage: document.getElementById('barred-message'),
            barredReason: document.getElementById('barred-reason'),

            // Containers
            adjustmentsGrid: document.getElementById('adjustments-grid'),
            adjustmentsContainer: document.getElementById('adjustments-container'),
            progressContainer: document.getElementById('progress-container'),
            milestoneDates: document.getElementById('milestone-dates'),

            // Progress
            totalDays: document.getElementById('total-days'),
            daysCompleted: document.getElementById('days-completed'),
            daysRemaining: document.getElementById('days-remaining'),
            progressPercent: document.getElementById('progress-percent'),
            progressBar: document.getElementById('progress-bar'),
            date25: document.getElementById('date-25'),
            date50: document.getElementById('date-50'),
            date75: document.getElementById('date-75'),
        };
        
        const allControls = [
            elements.visaCategory, elements.entryDate, elements.highEarnerControl, 
            elements.englishC1Control, elements.volunteeringControl, 
            elements.publicFunds, elements.immigrationBreach
        ];
        
        // --- Salary History Management ---
        let salaryEntryIndex = 1;
        
        function getSalaryHistory() {
            const entries = document.querySelectorAll('.salary-entry');
            const history = [];
            entries.forEach(entry => {
                const dateInput = entry.querySelector('.salary-start-date');
                const amountInput = entry.querySelector('.salary-amount');
                if (dateInput.value && amountInput.value) {
                    history.push({
                        startDate: new Date(dateInput.value),
                        annualSalary: parseFloat(amountInput.value)
                    });
                }
            });
            history.sort((a, b) => a.startDate - b.startDate);
            return history;
        }
        
        function calculateProRatedIncome(salaryHistory, fromDate, toDate) {
            if (salaryHistory.length === 0) return 0;
            
            const periodDays = (toDate - fromDate) / MS_IN_DAY;
            if (periodDays <= 0) return 0;
            
            let totalEarnings = 0;
            
            for (let i = 0; i < salaryHistory.length; i++) {
                const entry = salaryHistory[i];
                const nextEntry = salaryHistory[i + 1];
                
                const salaryStart = entry.startDate;
                const salaryEnd = nextEntry ? nextEntry.startDate : new Date(toDate.getTime() + 365 * MS_IN_DAY);
                
                const overlapStart = new Date(Math.max(salaryStart.getTime(), fromDate.getTime()));
                const overlapEnd = new Date(Math.min(salaryEnd.getTime(), toDate.getTime()));
                
                if (overlapEnd > overlapStart) {
                    const overlapDays = (overlapEnd - overlapStart) / MS_IN_DAY;
                    const dailyRate = entry.annualSalary / 365.25;
                    totalEarnings += dailyRate * overlapDays;
                }
            }
            return (totalEarnings / periodDays) * 365.25;
        }
        
        function findEarliestQualifyingDate(salaryHistory, threshold, entryDate) {
            if (salaryHistory.length === 0) return null;
            
            const firstSalaryDate = salaryHistory[0].startDate;
            const today = new Date();
            const futureLimit = new Date(today.getTime() + 20 * 365.25 * MS_IN_DAY);
            
            const searchStart = new Date(Math.max(entryDate.getTime(), firstSalaryDate.getTime()) + THREE_YEARS_IN_DAYS * MS_IN_DAY);
            
            let checkDate = new Date(searchStart);
            
            while (checkDate < futureLimit) {
                let allYearsQualify = true;
                let yearDetails = [];
                
                for (let yearOffset = 0; yearOffset < 3; yearOffset++) {
                    const yearEnd = new Date(checkDate.getTime() - yearOffset * ONE_YEAR_DAYS * MS_IN_DAY);
                    const yearStart = new Date(yearEnd.getTime() - ONE_YEAR_DAYS * MS_IN_DAY);
                    
                    if (yearStart < entryDate) {
                        allYearsQualify = false;
                        break;
                    }
                    
                    const annualIncome = calculateProRatedIncome(salaryHistory, yearStart, yearEnd);
                    yearDetails.push({ yearStart, yearEnd, annualIncome });
                    
                    if (annualIncome < threshold) {
                        allYearsQualify = false;
                        break;
                    }
                }
                
                if (allYearsQualify) {
                    return { date: checkDate, yearDetails };
                }
                checkDate = new Date(checkDate.getTime() + MS_IN_DAY);
            }
            return null;
        }
        
        const MAX_SALARY_ENTRIES = 4;
        
        function addSalaryEntry() {
            const container = elements.salaryHistoryContainer;
            const entries = container.querySelectorAll('.salary-entry');
            
            if (entries.length >= MAX_SALARY_ENTRIES) return;
            
            const newEntry = document.createElement('div');
            newEntry.className = 'salary-entry grid grid-cols-2 gap-3 fade-in';
            newEntry.dataset.index = salaryEntryIndex++;
            newEntry.innerHTML = `
                <div class="relative">
                    <label class="text-[10px] uppercase tracking-wider font-bold text-stone-400 mb-1 block">Effective Date</label>
                    <input type="date" class="salary-start-date w-full text-sm px-3 py-2 bg-white border border-stone-200 rounded focus:ring-1 focus:ring-teal-700 focus:border-teal-700">
                    <button type="button" class="remove-salary-btn absolute -right-6 top-6 text-stone-400 hover:text-rose-500" title="Remove">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div>
                    <label class="text-[10px] uppercase tracking-wider font-bold text-stone-400 mb-1 block">Annual Taxable Income (¬£)</label>
                    <input type="number" class="salary-amount w-full text-sm px-3 py-2 bg-white border border-stone-200 rounded focus:ring-1 focus:ring-teal-700 focus:border-teal-700 font-medium" placeholder="e.g. 55000" min="0" step="1000">
                </div>
            `;
            container.appendChild(newEntry);
            
            newEntry.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', calculateILRDate);
                input.addEventListener('input', calculateILRDate);
            });
            newEntry.querySelector('.remove-salary-btn').addEventListener('click', () => {
                newEntry.remove();
                updateSalaryUI();
                calculateILRDate();
            });
            
            updateSalaryUI();
        }
        
        function updateSalaryUI() {
            const entries = document.querySelectorAll('.salary-entry');
            entries.forEach((entry) => {
                const btn = entry.querySelector('.remove-salary-btn');
                if (btn) {
                    btn.classList.toggle('hidden', entries.length <= 1);
                }
            });
            if (elements.addSalaryBtn) {
                elements.addSalaryBtn.classList.toggle('hidden', entries.length >= MAX_SALARY_ENTRIES);
            }
        }
        
        const formatDate = (date) => {
            if (!(date instanceof Date) || isNaN(date)) return 'Invalid Date';
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return date.toLocaleDateString('en-GB', options);
        };
        
        function updateFirstSalaryDate() {
            const entryDateStr = elements.entryDate.value;
            if (!entryDateStr) return;
            
            const entryDate = new Date(entryDateStr);
            const today = new Date();
            const fourYearsAgo = new Date(today.getTime() - (4 * ONE_YEAR_DAYS * MS_IN_DAY));
            
            const forcedStartDate = entryDate > fourYearsAgo ? entryDate : fourYearsAgo;
            
            const yyyy = forcedStartDate.getFullYear();
            const mm = String(forcedStartDate.getMonth() + 1).padStart(2, '0');
            const dd = String(forcedStartDate.getDate()).padStart(2, '0');
            
            if (elements.firstSalaryDate) {
                elements.firstSalaryDate.value = `${yyyy}-${mm}-${dd}`;
            }
            
            if (elements.salaryStartLabel) {
                elements.salaryStartLabel.textContent = entryDate > fourYearsAgo ? 
                    `arrival (${formatDate(entryDate)})` : 
                    `4 years ago (${formatDate(fourYearsAgo)})`;
            }
            
            // Update the threshold date in radio button label
            const incomeThresholdDate = document.getElementById('income-threshold-date');
            if (incomeThresholdDate) {
                incomeThresholdDate.textContent = formatDate(forcedStartDate);
            }
        }
        
        // --- UI State Management ---
        function lockDownFormOnMandatoryFail(disable, controlsToExclude = []) {
            const allInputs = document.querySelectorAll('#calculator-form input, #calculator-form select');
            const excludeIds = ['visa-category', 'entry-date', ...controlsToExclude.map(c => c.id)];

            allInputs.forEach(control => {
                const shouldExclude = excludeIds.includes(control.id) || control.type === 'radio';
                
                if (disable && !shouldExclude) {
                    control.setAttribute('disabled', 'disabled');
                    control.classList.add('disabled-control');
                } else {
                    control.removeAttribute('disabled');
                    control.classList.remove('disabled-control');
                }
            });
            
            if (disable) {
                elements.reductionNote?.classList.add('hidden');
                elements.reductionNoteDefault?.classList.add('hidden');
                elements.maxReductionNote?.classList.add('hidden');
                elements.earningDateControls?.classList.add('hidden');
            }
        }
        
        function handleUIState() {
            const highEarnerValue = elements.highEarnerControl.value;
            const englishC1Value = elements.englishC1Control.value;
            const visaValue = elements.visaCategory.value;

            const isBarredBySuitability = highEarnerValue === '99' || englishC1Value === '99';

            elements.incomeBarError.classList.add('hidden');
            elements.englishBarError.classList.add('hidden');

            if (isBarredBySuitability) {
                let controlsToExclude = [];
                let reason = '';

                if (highEarnerValue === '99') {
                    controlsToExclude.push(elements.highEarnerControl);
                    elements.incomeBarError.classList.remove('hidden');
                    reason = "Income below threshold.";
                }
                if (englishC1Value === '99') {
                    controlsToExclude.push(elements.englishC1Control);
                    elements.englishBarError.classList.remove('hidden');
                    if (reason) reason += " ";
                    reason += "English proficiency below B2.";
                }

                elements.barredReason.textContent = reason;
                lockDownFormOnMandatoryFail(true, controlsToExclude);
                return true; 
            } else {
                lockDownFormOnMandatoryFail(false, []); 
            }
            
            if (visaValue === '0_DEPENDENT') {
                lockDownFormOnMandatoryFail(true, [elements.visaCategory]); 
                elements.dependentWarningBanner.classList.remove('hidden');
                return true; 
            } else {
                elements.dependentWarningBanner.classList.add('hidden');
            }

            const fixedRoutes = ['3_FASTTRACK', '5_FAMILY', '5_BNO', '5_PUBLIC'];
            const isFixedRoute = fixedRoutes.includes(visaValue);
            
            const reductionControls = [elements.highEarnerControl, elements.englishC1Control, elements.volunteeringControl];
            
            if (isFixedRoute) {
                elements.reductionNote.classList.remove('hidden'); 
                elements.reductionNoteDefault.classList.add('hidden');
                elements.maxReductionNote.classList.add('hidden');
                elements.earningDateControls.classList.add('hidden'); 
                
                reductionControls.forEach(control => {
                    control.setAttribute('disabled', 'disabled');
                    control.value = '0'; 
                    control.classList.add('disabled-control');
                });
                return false;
            } else {
                elements.reductionNote.classList.add('hidden');
                elements.reductionNoteDefault.classList.remove('hidden'); 
                
                reductionControls.forEach(control => {
                    if (control.value !== '99') {
                         control.removeAttribute('disabled');
                         control.classList.remove('disabled-control');
                    }
                });
            }
            
            const isMaxReduction = highEarnerValue === '-7';

            if (isMaxReduction) {
                elements.maxReductionNote.classList.remove('hidden');
                elements.volunteeringControl.setAttribute('disabled', 'disabled');
                elements.volunteeringControl.classList.add('disabled-control');
            } else {
                elements.maxReductionNote.classList.add('hidden');
                elements.volunteeringControl.removeAttribute('disabled');
                elements.volunteeringControl.classList.remove('disabled-control');
            }

            const isReductionSelected = highEarnerValue === '-5' || highEarnerValue === '-7';
            if (isReductionSelected && !isFixedRoute) {
                elements.earningDateControls.classList.remove('hidden');
            } else {
                elements.earningDateControls.classList.add('hidden');
            }
            
            return false; 
        }

        // --- Main Calculation ---
        function calculateILRDate() {
            const isBarred = handleUIState(); 

            elements.adjustmentsGrid.classList.add('hidden');
            elements.progressContainer.classList.add('hidden');
            elements.milestoneDates.classList.add('hidden');
            elements.barredMessage.classList.add('hidden'); 
            elements.salaryCheckIndicator.classList.add('hidden');

            if (isBarred) {
                if (elements.visaCategory.value === '0_DEPENDENT') {
                    elements.earliestDate.textContent = 'Guidance Pending';
                } else {
                    elements.barredMessage.classList.remove('hidden');
                    elements.earliestDate.textContent = 'Not Eligible';
                }
                
                elements.displayBaseline.textContent = '-';
                elements.displayReductionValue.textContent = '-';
                elements.displayReductionReason.textContent = '';
                elements.displayPenaltyValue.textContent = '-';
                elements.displayPenaltyReason.textContent = '';
                elements.displayAdjustment.textContent = '-';
                elements.finalRequiredYears.textContent = '-';
                return; 
            }
            
            const startDateStr = elements.entryDate.value;
            if (!startDateStr) {
                elements.earliestDate.textContent = '...';
                return;
            }

            const startDate = new Date(startDateStr);
            const today = new Date();
            const MIN_REQUIRED_YEARS = 3;

            const visaValue = elements.visaCategory.value;
            const fixedRoutes = ['3_FASTTRACK', '5_FAMILY', '5_BNO', '5_PUBLIC'];
            const isFixedRoute = fixedRoutes.includes(visaValue);

            const parts = visaValue.split('_');
            const baselineYears = parseInt(parts[0], 10);
            elements.baseYears.textContent = baselineYears;
            
            const publicFundsPenalty = parseInt(elements.publicFunds.value, 10);
            const breachPenalty = parseInt(elements.immigrationBreach.value, 10);
            const totalNegativeAdjustment = Math.max(0, publicFundsPenalty, breachPenalty);
            let penaltyReason = ""; 

            if (totalNegativeAdjustment === 20) penaltyReason = "Serious Breach";
            else if (totalNegativeAdjustment === 10) penaltyReason = "Public Funds (12mo+)";
            else if (totalNegativeAdjustment === 5) penaltyReason = "Public Funds (<12mo)";
            
            let potentialPositiveAdjustment = 0;
            let potentialReductionReason = "";
            const highEarnerValue = elements.highEarnerControl.value;
            const isReductionSelectedByUser = highEarnerValue === '-5' || highEarnerValue === '-7';

            if (!isFixedRoute) {
                let englishC1Input = elements.englishC1Control.value === '-1' ? -1 : 0;
                let volunteeringInput = elements.volunteeringControl.value === '-3' ? -3 : 0;
                let highEarnerInput = 0;
                if (highEarnerValue === '-5') highEarnerInput = -5;
                else if (highEarnerValue === '-7') highEarnerInput = -7;

                if (highEarnerInput === -7) {
                    englishC1Input = 0; 
                    volunteeringInput = 0;
                }

                potentialPositiveAdjustment = Math.min(0, highEarnerInput, englishC1Input, volunteeringInput);
                
                if (potentialPositiveAdjustment === -7) potentialReductionReason = "Max Earner (>¬£125k)";
                else if (potentialPositiveAdjustment === -5) potentialReductionReason = "High Earner (>¬£50k)";
                else if (potentialPositiveAdjustment === -3) potentialReductionReason = "Volunteering";
                else if (potentialPositiveAdjustment === -1) potentialReductionReason = "C1 English";
            }

            let totalPositiveAdjustment = potentialPositiveAdjustment;
            let reductionReason = potentialReductionReason;
            let salaryDelayedApplication = false;
            let reductionStillHelps = true;
            let salaryEligibilityDate = null;

            let baselineNoReductionYears = Math.max(MIN_REQUIRED_YEARS, baselineYears + totalNegativeAdjustment);
            let baselineCompletionDate = new Date(startDate);
            baselineCompletionDate.setFullYear(startDate.getFullYear() + baselineNoReductionYears);
            let baselineApplicationDate = new Date(baselineCompletionDate.getTime() - (DAYS_TO_SUBTRACT * MS_IN_DAY));

            elements.salaryCalculationBox?.classList.add('hidden');

            function calcEffectiveDate(threshold, reductionYears, salaryHistory, salaryOption) {
                const residenceYears = Math.max(MIN_REQUIRED_YEARS, baselineYears + reductionYears + totalNegativeAdjustment);
                const residenceComplete = new Date(startDate);
                residenceComplete.setFullYear(startDate.getFullYear() + residenceYears);
                const residenceAppDate = new Date(residenceComplete.getTime() - (DAYS_TO_SUBTRACT * MS_IN_DAY));
                
                let incomeEligDate = null;
                if (salaryOption === 'same') {
                    incomeEligDate = new Date(startDate.getTime() + (THREE_YEARS_IN_DAYS * MS_IN_DAY));
                } else if (salaryHistory && salaryHistory.length > 0) {
                    const result = findEarliestQualifyingDate(salaryHistory, threshold, startDate);
                    if (result) incomeEligDate = result.date;
                }
                
                if (!incomeEligDate) return null;
                const effectiveDate = new Date(Math.max(residenceAppDate.getTime(), incomeEligDate.getTime()));
                return { effectiveDate, residenceAppDate, incomeEligDate, residenceYears, threshold, reductionYears };
            }

            const salaryOption = document.querySelector('input[name="salary-start-time"]:checked')?.value;
            const salaryHistory = salaryOption === 'other' ? getSalaryHistory() : null;
            const hasSalaryHistory = salaryHistory && salaryHistory.length > 0;

            if (isReductionSelectedByUser) {
                let bestOption = null;
                let explanationHtml = '';
                
                if (salaryOption === 'same') {
                    const reductionYears = parseInt(highEarnerValue);
                    salaryEligibilityDate = new Date(startDate.getTime() + (THREE_YEARS_IN_DAYS * MS_IN_DAY));
                    
                    const residenceYears = Math.max(MIN_REQUIRED_YEARS, baselineYears + reductionYears + totalNegativeAdjustment);
                    const residenceComplete = new Date(startDate);
                    residenceComplete.setFullYear(startDate.getFullYear() + residenceYears);
                    const residenceAppDate = new Date(residenceComplete.getTime() - (DAYS_TO_SUBTRACT * MS_IN_DAY));
                    
                    const effectiveDate = new Date(Math.max(residenceAppDate.getTime(), salaryEligibilityDate.getTime()));
                    
                    if (effectiveDate >= baselineApplicationDate) reductionStillHelps = false;
                    
                } else if (hasSalaryHistory) {
                    const highEarnerResult = calcEffectiveDate(50270, -5, salaryHistory, salaryOption);
                    const maxEarnerResult = calcEffectiveDate(125140, -7, salaryHistory, salaryOption);
                    
                    let bestIsHighEarner = false;
                    if (highEarnerResult && maxEarnerResult) {
                        bestIsHighEarner = highEarnerResult.effectiveDate <= maxEarnerResult.effectiveDate;
                        bestOption = bestIsHighEarner ? highEarnerResult : maxEarnerResult;
                    } else if (highEarnerResult) {
                        bestOption = highEarnerResult;
                        bestIsHighEarner = true;
                    } else if (maxEarnerResult) {
                        bestOption = maxEarnerResult;
                        bestIsHighEarner = false;
                    }
                    
                    // Styles updated for new design with better contrast
                    const cardBase = "p-3 rounded-md text-xs border mb-2 bg-stone-50 border-stone-200 text-stone-600";
                    const cardGood = "p-3 rounded-md text-xs border mb-2 bg-teal-50 border-teal-200 text-teal-900 shadow-sm";
                    const cardBad = "p-3 rounded-md text-xs border mb-2 bg-stone-100 border-stone-200 text-stone-400";

                    explanationHtml = '<p class="font-bold mb-2 text-stone-700 text-xs uppercase tracking-wide">Comparison:</p>';
                    
                    if (highEarnerResult) {
                        const isBest = bestIsHighEarner;
                        const style = isBest ? `${cardGood} ring-1 ring-teal-500` : cardBase;
                        const check = isBest ? '<span class="text-teal-600 font-bold">‚úì</span> ' : '';
                        explanationHtml += `<div class="${style}">${check}<strong>High Earner (-5y)</strong><br><span class="mt-1 block">Earliest: ${formatDate(highEarnerResult.effectiveDate)}</span></div>`;
                    } else {
                        explanationHtml += `<div class="${cardBad}"><strong>High Earner</strong><br>Not met yet</div>`;
                    }
                    
                    if (maxEarnerResult) {
                        const isBest = !bestIsHighEarner && bestOption;
                        const style = isBest ? `${cardGood} ring-1 ring-teal-500` : cardBase;
                        const check = isBest ? '<span class="text-teal-600 font-bold">‚úì</span> ' : '';
                        explanationHtml += `<div class="${style}">${check}<strong>Max Earner (-7y)</strong><br><span class="mt-1 block">Earliest: ${formatDate(maxEarnerResult.effectiveDate)}</span></div>`;
                    } else {
                        explanationHtml += `<div class="${cardBad}"><strong>Max Earner</strong><br>Not met yet</div>`;
                    }

                    if (bestOption) {
                        totalPositiveAdjustment = bestOption.reductionYears;
                        salaryEligibilityDate = bestOption.incomeEligDate;
                        reductionReason = bestOption.threshold === 125140 ? 'Max Earner (best)' : 'High Earner (best)';
                        
                        if (bestOption.effectiveDate >= baselineApplicationDate) {
                            reductionStillHelps = false;
                            explanationHtml += `<p class="text-rose-600 font-medium mt-1 text-xs">No benefit vs baseline.</p>`;
                        } else {
                            const daysSaved = Math.round((baselineApplicationDate - bestOption.effectiveDate) / MS_IN_DAY);
                            explanationHtml += `<p class="text-teal-800 font-bold mt-2 text-xs">Saves ${(daysSaved/365.25).toFixed(1)} years!</p>`;
                        }
                    } else {
                        reductionStillHelps = false;
                        explanationHtml += `<p class="text-rose-600 mt-2 font-medium text-xs">Thresholds not met.</p>`;
                    }
                } else {
                    explanationHtml = '<p class="text-stone-500 italic">Enter salary history to calculate.</p>';
                }
                
                if (elements.salaryCalculationBox && elements.salaryCalculationExplanation) {
                    elements.salaryCalculationBox.classList.remove('hidden');
                    elements.salaryCalculationExplanation.innerHTML = explanationHtml;
                }
            }

            if (isReductionSelectedByUser && !reductionStillHelps) {
                elements.salaryCheckIndicator.classList.remove('hidden');
                elements.salaryCheckIndicator.textContent = "* Income reduction not effective based on history/timing.";
                
                const englishC1Input = elements.englishC1Control.value === '-1' ? -1 : 0;
                const volunteeringInput = elements.volunteeringControl.value === '-3' ? -3 : 0;
                
                totalPositiveAdjustment = Math.min(0, englishC1Input, volunteeringInput);
                
                if (totalPositiveAdjustment === -3) reductionReason = "Volunteering (-3y)";
                else if (totalPositiveAdjustment === -1) reductionReason = "English C1 (-1y)";
                else reductionReason = "None";
                
                salaryEligibilityDate = null;
            } else if (isReductionSelectedByUser && salaryDelayedApplication) {
                // ...
            }

            let finalRequiredYears = baselineYears + totalPositiveAdjustment + totalNegativeAdjustment;
            finalRequiredYears = Math.max(MIN_REQUIRED_YEARS, finalRequiredYears);
            
            let completionDate = new Date(startDate);
            completionDate.setFullYear(startDate.getFullYear() + finalRequiredYears);
            let residenceBasedAppDate = new Date(completionDate.getTime() - (DAYS_TO_SUBTRACT * MS_IN_DAY));
            
            let earliestApplicationDate;
            if (salaryEligibilityDate && reductionStillHelps) {
                earliestApplicationDate = new Date(Math.max(residenceBasedAppDate.getTime(), salaryEligibilityDate.getTime()));
            } else {
                earliestApplicationDate = residenceBasedAppDate;
            }
            
            const totalRequiredDays = Math.round((earliestApplicationDate.getTime() - startDate.getTime()) / MS_IN_DAY);
            const timeElapsedMs = today.getTime() - startDate.getTime();
            const daysCompleted = Math.max(0, Math.floor(timeElapsedMs / MS_IN_DAY));
            const daysRemaining = Math.max(0, totalRequiredDays - daysCompleted);
            const progress = totalRequiredDays > 0 ? Math.min(100, (daysCompleted / totalRequiredDays) * 100) : 0;
            
            const milestoneDate = (percent) => {
                const daysToAdd = Math.round(totalRequiredDays * (percent / 100));
                let date = new Date(startDate);
                date.setDate(startDate.getDate() + daysToAdd);
                return formatDate(date);
            };

            const totalAdjustment = finalRequiredYears - baselineYears;
            
            elements.displayBaseline.textContent = baselineYears;
            elements.displayReductionValue.textContent = totalPositiveAdjustment === 0 ? 'None' : `${totalPositiveAdjustment} yr`;
            elements.displayReductionReason.textContent = totalPositiveAdjustment === 0 ? '' : reductionReason;
            elements.displayPenaltyValue.textContent = totalNegativeAdjustment === 0 ? 'None' : `+${totalNegativeAdjustment} yr`;
            elements.displayPenaltyReason.textContent = totalNegativeAdjustment === 0 ? '' : penaltyReason;
            
            const adjustmentPrefix = totalAdjustment > 0 ? '+' : '';
            elements.displayAdjustment.textContent = totalAdjustment === 0 ? '0' : `${adjustmentPrefix}${totalAdjustment} yr`;
            elements.finalRequiredYears.textContent = finalRequiredYears;
            
            elements.earliestDate.textContent = formatDate(earliestApplicationDate);
            
            elements.adjustmentsGrid.classList.remove('hidden');
            elements.progressContainer.classList.remove('hidden');
            elements.milestoneDates.classList.remove('hidden');
            
            elements.totalDays.textContent = totalRequiredDays;
            elements.daysCompleted.textContent = daysCompleted;
            elements.daysRemaining.textContent = daysRemaining;
            elements.progressPercent.textContent = `${progress.toFixed(0)}%`;
            elements.progressBar.style.width = `${progress}%`;
            
            elements.date25.textContent = milestoneDate(25);
            elements.date50.textContent = milestoneDate(50);
            elements.date75.textContent = milestoneDate(75);
        }

        // --- URL State Management ---
        function generateShareableURL() {
            const params = new URLSearchParams();
            
            // Core form values
            params.set('d', elements.entryDate.value); // entry date
            params.set('v', elements.visaCategory.value); // visa
            params.set('e', elements.highEarnerControl.value); // earner
            params.set('l', elements.englishC1Control.value); // language
            params.set('w', elements.volunteeringControl.value); // volunteering
            params.set('p', elements.publicFunds.value); // public funds
            params.set('b', elements.immigrationBreach.value); // breach
            
            // Salary history mode
            const salaryMode = document.querySelector('input[name="salary-start-time"]:checked')?.value || 'same';
            params.set('sm', salaryMode);
            
            // Salary history entries (only if mode is 'other')
            if (salaryMode === 'other') {
                const history = getSalaryHistory();
                if (history.length > 0) {
                    // Compact format: date1,amount1;date2,amount2
                    const historyStr = history.map(h => {
                        const d = h.startDate;
                        const dateStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                        return `${dateStr},${h.annualSalary}`;
                    }).join(';');
                    params.set('sh', historyStr);
                }
            }
            
            return `${window.location.origin}${window.location.pathname}?${params.toString()}`;
        }
        
        function copyShareableLink() {
            const url = generateShareableURL();
            const feedback = document.getElementById('share-feedback');
            const btnText = document.getElementById('share-btn-text');
            
            navigator.clipboard.writeText(url).then(() => {
                btnText.textContent = 'Link copied!';
                feedback.textContent = 'Shareable link copied to clipboard';
                feedback.classList.remove('hidden');
                
                setTimeout(() => {
                    btnText.textContent = 'Share this tracker';
                    feedback.classList.add('hidden');
                }, 3000);
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                btnText.textContent = 'Link copied!';
                feedback.textContent = 'Shareable link copied to clipboard';
                feedback.classList.remove('hidden');
                
                setTimeout(() => {
                    btnText.textContent = 'Share this tracker';
                    feedback.classList.add('hidden');
                }, 3000);
            });
        }
        
        function loadStateFromURL() {
            const params = new URLSearchParams(window.location.search);
            
            // Check if we have any params
            if (params.size === 0) return false;
            
            // Load core values
            if (params.has('d')) elements.entryDate.value = params.get('d');
            if (params.has('v')) elements.visaCategory.value = params.get('v');
            if (params.has('e')) elements.highEarnerControl.value = params.get('e');
            if (params.has('l')) elements.englishC1Control.value = params.get('l');
            if (params.has('w')) elements.volunteeringControl.value = params.get('w');
            if (params.has('p')) elements.publicFunds.value = params.get('p');
            if (params.has('b')) elements.immigrationBreach.value = params.get('b');
            
            // Load salary mode
            const salaryMode = params.get('sm') || 'same';
            if (salaryMode === 'same') {
                elements.salaryStartSameRadio.checked = true;
                elements.salaryHistorySection?.classList.add('hidden');
            } else {
                elements.salaryStartOtherRadio.checked = true;
                elements.salaryHistorySection?.classList.remove('hidden');
            }
            
            // Load salary history
            if (salaryMode === 'other' && params.has('sh')) {
                const historyStr = params.get('sh');
                const entries = historyStr.split(';').filter(s => s);
                
                // Clear existing entries except first
                const container = elements.salaryHistoryContainer;
                const existingEntries = container.querySelectorAll('.salary-entry');
                existingEntries.forEach((entry, i) => {
                    if (i > 0) entry.remove();
                });
                
                entries.forEach((entryStr, i) => {
                    const [dateStr, amount] = entryStr.split(',');
                    
                    if (i === 0) {
                        // First entry - just fill in the amount (date is auto-set)
                        const firstAmountInput = container.querySelector('.salary-entry .salary-amount');
                        if (firstAmountInput) firstAmountInput.value = amount;
                    } else {
                        // Add new entry
                        addSalaryEntry();
                        const allEntries = container.querySelectorAll('.salary-entry');
                        const newEntry = allEntries[allEntries.length - 1];
                        const dateInput = newEntry.querySelector('.salary-start-date');
                        const amountInput = newEntry.querySelector('.salary-amount');
                        if (dateInput) dateInput.value = dateStr;
                        if (amountInput) amountInput.value = amount;
                    }
                });
            }
            
            return true;
        }

        allControls.forEach(control => {
            const handler = () => calculateILRDate();
            control.addEventListener('change', handler);
            control.addEventListener('input', handler); 
        });
        
        elements.entryDate.addEventListener('change', () => {
            updateFirstSalaryDate();
            calculateILRDate();
        });

        document.querySelectorAll('input[name="salary-start-time"]').forEach(radio => {
            radio.addEventListener('change', () => {
                if (elements.salaryHistorySection) {
                    elements.salaryHistorySection.classList.toggle('hidden', radio.value !== 'other');
                }
                updateFirstSalaryDate();
                calculateILRDate();
            });
        });

        elements.addSalaryBtn?.addEventListener('click', addSalaryEntry);
        
        document.querySelectorAll('.salary-entry input:not(#first-salary-date)').forEach(input => {
            input.addEventListener('change', calculateILRDate);
            input.addEventListener('input', calculateILRDate);
        });
        
        // Share button handler
        document.getElementById('share-btn')?.addEventListener('click', copyShareableLink);
        
        document.addEventListener('DOMContentLoaded', () => {
            // Try to load from URL first
            const loadedFromURL = loadStateFromURL();
            
            if (!loadedFromURL && !elements.entryDate.value) {
                elements.entryDate.value = '2026-04-01';
            }
            
            updateFirstSalaryDate();
            elements.visaCategory.dispatchEvent(new Event('change'));
            calculateILRDate();
            
            // Scroll to results if loaded from shared URL
            if (loadedFromURL) {
                setTimeout(() => {
                    document.getElementById('result-message')?.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }, 300);
            }
        });

    </script>
</body>
</html>
